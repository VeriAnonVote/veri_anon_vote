# 可验证的匿名投票系统 VeriAnonVote

## 1. 项目简介

本项目是一个开源的全栈解决方案，旨在提供一个安全、匿名且可验证的电子投票系统。它利用**可链接环签名 (Linkable Ring Signature)** 技术，特别是 **[BLSAG](https://github.com/edwinhere/nazgul) (Back's Linkable Spontaneous Anonymous Group signatures)** 的实现，来确保选民在投票过程中的隐私，同时防止欺诈行为（如重复投票），并允许对选举结果进行公开验证。

**核心优势:**

* **强匿名性:** 只要选民的私钥未泄露, 即使投票结果完全公开，外界将任何一张具体的选票与投票者的身份对应起来的概率为`1/{选民登记人数}`。
* **可验证性:** 整个选举过程和结果是可审计和验证的，依赖于现代密码学保证和公开可查验审计的的选民登记记录。
* **防欺诈:** 可链接环签名技术可检测并阻止使用同一身份（私钥）进行重复投票。
* **密钥泄露应对:** 即使选民私钥不幸被盗，攻击者无法阻止选民发现异常投票并吊销该私钥的投票记录。
* **Tor 网络支持:** 提供 Tor Onion Service 配置，允许在没有公共 IP 或域名的情况下部署服务器，并强制通过 Tor 网络访问以增强匿名性。

## 2. 核心技术概念

理解本系统的工作原理，需要了解以下几个关键的密码学概念：

### 2.1 [非对称加密（公钥密码学）](https://zh.wikipedia.org/wiki/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)

这是现代安全通信和数字签名的基石。每个用户（在本系统中是选民或民调参与者）拥有一对密钥：

* **公钥 (Public Key, PK):** 可以公开分发。在本系统中，经过验证的选民公钥会被收集并公示，用于组成“环”和验证签名。
* **私钥 (Secret Key, sk):** 必须由用户（选民）严格保密。用于生成数字签名，以表达投票意愿。

**核心安全假设:** 基于当前的计算能力（成熟的量子计算机尚未面世），从公钥逆向推导出私钥是不可行的。对于足够强度的密钥（例如256位或更高），即使使用超级计算机, 破解所需的时间和资金成本是天文数字，不具备实际操作性。

### 2.2 [环签名 (Ring Signature)](https://en.wikipedia.org/wiki/Ring_signature)

环签名是一种特殊的数字签名方案，它允许签名者：

1.  选择一个包含自己公钥在内的公钥集合（称为“环”或“Ring”）。
2.  使用自己的私钥，对某个消息（例如选票内容）进行签名，该签名代表了整个“环”。
3.  验证者可以使用环中所有成员的公钥来验证签名的有效性，确认签名确实来自环中**某一个**成员。

**关键特性：无条件匿名性 (Unconditional Anonymity)**
验证者虽然能确认签名有效，但无法确定签名具体是由环中的哪一个成员生成的。在投票场景中，这意味着每个投票行为都被混淆在所有合资格的选民（环成员）中，无法追踪到具体的投票人。

### 2.3 可链接环签名 (Linkable Ring Signature) - BLSAG

可链接环签名（本项目使用BLSAG实现）在标准环签名的基础上，增加了一个至关重要的特性：**可链接性 (Linkability)**。

* **检测重复:** 如果同一个签名者（拥有同一个私钥）在**同一个**指定场景下（例如，针对同一次选举的同一个投票议题）签署了**多条**消息（投了多张票），这些由他生成的签名可以通过一个公开的算法被“链接”起来。
* **身份仍匿名:** 这种链接操作只会揭示“这些签名来自同一个人”，但**仍然不会暴露**这个签名者的具体身份（公钥）。

**应用效果:** 这种机制能够在不牺牲选民匿名性的前提下，有效地检测并阻止恶意的重复投票行为 (Double Voting)。

## 3. 系统角色

本系统定义了四个主要角色：

1.  **登记机构 (Voter Registrar):**
    * 负责运行选民登记服务器。
    * 收集并存储由验证者确认的合格选民公钥。
    * 最终发布用于构成环签名的公开公钥列表。
    * *运营说明:* 此角色可以由政府机构、独立委员会或**具备公信力的私营公司/组织甚至个人**承担，前提是登记时记录的证据(能事后证明被登记者符合选举资格以及被登记者是第一次登记)**没有伪造的可能, 并且被妥善存储**，可以开放下载,被任何第三方进行审计。
2.  **验证者 (Verifier):**
    * 由登记机构授权。
    * 负责核验申请登记的选民身份和选举资格。
    * 确保登记过程可查证（例如，通过影像记录），防止重复登记。
    * 使用自己的凭证（如以太坊钱包签名）签署证明，确认选民资格并将选民公钥上传给登记机构。
    * *运营说明:* 与登记机构类似，验证者的角色也可以由授权的**私营实体**承担，关键在于验证过程的**标准化、透明化和可审计性**。
3.  **选民 (Voter):**
    * 拥有唯一的密钥对（公钥PK，私钥sk）。
    * 向验证者证明身份和资格以完成登记，公钥被纳入环中。
    * 使用自己的私钥对选票进行可链接环签名。
    * 将环签名signature上传至Election Organizer的服务器, 或安全地打印成二维码, 匿名地邮寄或投入选票箱
    * 妥善备份和保管自己的私钥。
4.  **选举组织者 (Election Organizer):**
    * 负责运行选举投票服务器。
    * 从登记机构获取最终的选民公钥环。
    * 接收并存储选民提交的（已签名的）选票。
    * 公开计票结果（签名列表和对应的投票内容）。
    * *说明:* 此角色通常与登记机构分离以实现权责分立，但也可以由同一可信实体兼任。

## 4. 系统工作流程

1.  **准备阶段:**
    * `Voter Registrar` (登记机构) 收集并授权 `Verifier`(验证者) 的身份标识（例如ETH地址）。
    * `Voter Registrar` 启动并运行选民登记服务器。
2.  **选民登记阶段 (关键环节):**
    * `Voter` (选民) 使用客户端生成自己的密钥对(PK, sk)和助记词，并**务必安全备份助记词**。
    * `Voter` 向 `Verifier` (验证者) 出示自己的公钥(PK)和选举资格证明材料。
    * `Verifier` 严格核对 `Voter` 的身份和资格，并进行可查证的记录（例如，录制包含面部信息、公钥二维码和身份证明的视频），以防止同一个人重复登记获取多个投票资格。**所有登记记录（包括用于验证的证据，如视频链接或哈希）应可公开查阅和审计。**
    * `Verifier` 确认无误后，使用自己的凭证（如ETH钱包）对一条包含 `Voter` 公钥的证明消息进行签名。
    * `Verifier` 将 `Voter` 的公钥和自己的签名证明一起上传给 `Voter Registrar` (登记机构) 的服务器。
    * *(可选在线登记流程):* `Voter` 可自行录制包含可信身份信息和公钥的视频，上传至公开平台（如YouTube/Twitter），将链接分享给 `Verifier`。`Verifier` 审核并备份视频后，履行上述签名和上传职责。此方式特别考虑了流亡政府或地理分散的组织需求。
3.  **登记结束与公钥环公示:**
    * 登记期结束后，`Voter Registrar` (登记机构) 整理所有通过验证的选民公钥，形成最终的“公钥环”，并将其**公开**。这个环是后续投票的基础。
4.  **选举投票阶段:**
    * `Election Organizer` (选举组织者) 启动选举服务器，并从 `Voter Registrar` (登记机构) 指定的地址获取公开的公钥环。
    * `Voter` (选民) 在客户端选择投票选项，使用自己的**私钥(sk)** 和**公开的公钥环**对选票内容进行**可链接环签名 (BLSAG)**。
    * `Voter` 将生成的签名后的选票上传给 `Election Organizer` (选举组织者) 的服务器。
5.  **计票与审计阶段:**
    * 投票结束后，`Election Organizer` (选举组织者) **公开**所有收到的有效签名选票记录 (vote records)。
    * 任何人都可以：
        * 使用公开的公钥环验证每一张选票签名的有效性。
        * 使用BLSAG的链接算法检查是否存在由同一身份（未知）投出的重复选票。重复选票应被视为无效。
        * 结合**公开的选民登记记录**进行审计，确保公钥环的初始构建是可信的、完整的，且没有遗漏或包含不合格者。

## 5. 安全性与可信性逻辑论证

本系统的安全性和可信性建立在一系列密码学公理和系统设计前提之上。

**前提与公理:**

* **公理1 (非对称加密 - 密钥对安全):** 对于足够强度（如256位及以上）的密钥对，从公钥(PK)反推出私钥(sk)在现有计算机性能下是成本上完全不可行的。
* **公理2 (非对称加密 - 签名不可伪造):** 只有持有私钥(sk)的人才能生成对应公钥(PK)能够验证通过的有效数字签名。
* **公理3 (环签名 - 正确性):** 使用环 R 中某个成员的私钥 sk_i (对应公钥 PK_i ∈ R) 对消息 M 生成的有效环签名 S，一定能够通过环 R 中的所有公钥验证。
* **公理4 (环签名 - 匿名性):** 给定一个有效的环签名 S、消息 M 和公钥环 R，无法在计算上确定该签名 S 是由环 R 中哪一个具体成员的私钥生成的。
* **公理5 (可链接环签名 - 可链接性):** 若同一个私钥 sk_i 在同一链接上下文（如同一场选举 E）中生成了两个签名 S1 和 S2，开源算法可以轻松发现 S1 和 S2 来自同一签名者，但仍无法确定该签名者的具体身份。
* **公理6 (可链接环签名 - 不可伪造性):** 没有环 R 中任何成员私钥的攻击者，无法为消息 M 生成一个能够通过环 R 验证的有效（可链接）环签名。
* **前提1 (系统设计 - 选民登记完整性与透明性):** 选民登记过程是**公开、透明且严格执行**的。确保：(a) 只有具备资格的选民才能登记；(b) 每个合格选民只有一个公钥被纳入最终的公钥环 R；(c) 登记过程的所有记录（包括身份验证证据）都可供公众审计；(d) 最终的公钥环 R 是公开、准确且完整的。**这是整个系统可信的基石。**
* **前提2 (用户行为 - 私钥安全):** 每个选民都妥善保管自己的私钥(sk)和签名，不与他人共享。

**逻辑证明:**

1.  **证明：当选民私钥未泄露时，投票是匿名的。**
    * 选民使用自己的私钥 sk_i 和公开的公钥环 R 对选票 M 进行签名，生成 S (依据流程)。
    * 签名 S 是有效的，可以被公开验证 (依据公理3)。
    * 根据公理4 (环签名匿名性)，即使 S、M、R 都公开，外界也无法将 S 与 R 中的任何特定公钥 PK_j (包括 PK_i) 关联起来。
    * **结论：** 只要选民私钥 sk_i 未泄露 (前提2)，其投票行为相对于环 R 中的其他成员是匿名的。

2.  **证明：当选民私钥未泄露时，任何外部人员（包括选举组织者）无法伪造或篡改选票。**
    * 假设攻击者（非环内成员，或环内其他成员 j）想伪造选民 i 的选票 M , 将伪造的选票M'投给另一个候选人。
    * 要使伪造的选票 M' 被接受，攻击者必须生成一个使用环 R 且能验证通过的有效签名 S'。
    * 根据公理6 (环签名不可伪造性)，生成这样的 S' 需要拥有环 R 中至少一个成员的私钥。
    * 由于选民 i 的私钥 sk_i 未泄露 (前提2)，且攻击者不是选民 i 本人，攻击者不持有 sk_i。
    * 如果攻击者是环内其他成员 j，他可以用自己的 sk_j 生成签名，但这代表的是他自己的投票意愿，而非伪造选民 i 的。
    * 如果攻击者是外部人员，他不持有 R 中任何成员的私钥。
    * **结论：** 在私钥安全的前提下，没有任何办法可以伪造一张代表特定选民意愿（如果可以确定的话）或不属于任何环内成员的有效选票。

3.  **证明：系统可以检测并阻止重复投票。**
    * 假设选民 i (或盗用其私钥者) 尝试在同一场选举 E 中，使用私钥 sk_i 投两张票 M1 和 M2，生成了签名 S1 和 S2。
    * 根据公理5 (可链接环签名 - 可链接性)，存在公开算法可以检测到 S1 和 S2 是由同一个（但未知的）私钥在同一链接上下文（选举E）中生成的。
    * 选举组织者或任何审计者运行此链接算法，可以识别出这一对（或多对）关联签名。
    * 系统规则可以设定，凡是被链接起来的签名对均视为无效投票。
    * **结论：** 可链接性确保了任何尝试使用同一身份（私钥）进行多次投票的行为都可以被检测到，从而阻止了重复投票计入有效票数。

4.  **证明：即使选民私钥被盗，选民也能发现并寻求补救，防止非意愿投票生效。**
    * 假设选民 i 的私钥 sk_i 被盗，盗用者使用 sk_i 投了一张票 M'，生成签名 S'，并提交给选举组织者。
    * 所有投票记录 S' (及其对应 M') 是公开透明的。
    * 选民 i 可以查看公开的投票记录。虽然他不能直接看出 S' 是谁投的 (匿名性)，但他可以通过以下方式**发现异常**：
        * 如果他自己尚未投票，却发现系统中存在一个与他的密钥对生成的key_image相同的记录。
        * 如果他自己也投了票 S，那么 S 和 S' 会因为来自同一个私钥 sk_i 而被**链接**起来 (公理5)。选民 i 看到这个链接，就知道自己的私钥被盗用了。
    * 一旦发现异常，选民 i 可以立即通过联系选举委员会(甚至公开广播到社交媒体) 向 `Election Organizer` 报告私钥失窃和存在非自愿投票 S'。
    * 组织者在核实选民 i 的身份和报案后，可以将 S' 标记为无效。
    * 同时，系统可以允许选民 i 通过其他经过验证的途径（例如，在监督下进行传统方式投票）来表达其真实的投票意愿。
    * **结论：** 透明度和可链接性使得私钥被盗后的非自愿投票可以被合法选民发现，并提供了请求撤销和补救的途径，尽管这依赖于及时的发现和有效的带外沟通机制。

**重要提示：** 上述所有安全保证都**强依赖于前提1**，即**选民登记过程的公正、透明和严格执行**。如果登记环节出现问题（例如，允许不合格人员登记、允许一人注册多个公钥、未能有效防止身份冒用、登记记录不公开或不完整），那么即使后续的密码学投票过程完美无缺，选举结果的合法性和可信性也将受到根本性的破坏。因此，设计和执行一个可靠、公开、可审计的选民登记与验证流程至关重要，其重要性甚至超过投票技术本身。

## 6. 当前状态与未来展望

* **当前状态:** 本项目目前处于**原型阶段**。核心功能已实现，但尚未经过充分的优化、广泛测试和专业的安全审计。**暂时不建议在当前阶段将其用于任何具有重大影响力的官方选举或投票活动。**
* **目标用户 (现阶段):** 希望优先由对技术感兴趣的群体进行试用、迭代和贡献，例如：
    * 计算机系的学生和研究人员
    * 自由软件开发者和爱好者
    * 需要匿名投票机制的非政府组织、工会、社团
    * 专业民意调查机构/公司(媒体集团)
* **未来目标:**
    1.  **安全性强化:** 接受来自开源社区和专业安全机构的全面代码审计，修复潜在漏洞。
    2.  **抗攻击能力:** 提升系统对分布式拒绝服务 (DoS) 等常见网络攻击的抵抗能力。
    3.  **易用性提升:** 开发极其友好的**开源**选民客户端，确保普通选民无需专业知识也能轻松、安全地完成注册和投票。
    4.  **性能优化:** 优化签名生成、验证和链接算法的计算效率，以及投票数据的存储效率，确保在选民规模达到数十万甚至百万级别时，系统仍能保持可接受的性能（例如，通过 pre-hashing 等技术优化环签名性能）。
    5.  **完善文档与部署指南:** 提供清晰、完整的文档和部署操作说明。

**终极愿景:** 将本项目发展成为一个成熟、可靠、经过实战检验的解决方案，使其有能力支持state级乃至国家级别的政治选举，真正实现安全、匿名、可验证的民主投票实践。

## 7. 功能与改进清单 (Features & To-Do List)

本项目目前实现了核心的匿名投票流程，但仍有大量工作需要完成以达到生产级别标准。

### 核心功能 (已实现)
- [x] **基础架构:** 实现了 `voter_registrar`, `verifier`, `voter`, `election_organizer` 四个角色的基本交互逻辑。
- [x] **密钥管理:** 客户端支持生成密钥对和助记词。
- [x] **选民登记:** 支持验证者核验、签名并上传选民公钥。
- [x] **在线登记流程:** 支持通过提交含身份信息的视频链接进行登记。
- [x] **环签名核心:** 实现基于 BLSAG 的可链接环签名生成与验证。
- [x] **投票流程:** 支持选民使用私钥对选票签名并提交。
- [x] **计票与公开:** 选举组织者可接收选票并公开投票记录。
- [x] **重复投票检测:** 利用 BLSAG 的可链接性检测同一私钥的多次投票。
- [x] **Tor 网络支持:** 提供 `veri_anon_vote_server.torrc` 配置文件，支持通过 Onion Service 部署和访问。

### 代码质量与可维护性 (待办)
- [ ] **文档完善:** 为所有模块、主要函数和复杂逻辑添加详尽的注释和说明文档。
- [ ] **后端重构与抽象:** 审视现有后端代码结构，进行必要的重构以提高模块化和降低耦合度。
- [ ] **前端重构:** 对 AI 生成的前端代码进行重构，建立清晰结构、状态管理和规范，增加文档和测试。

### 性能优化 (待办)
- [ ] **环签名/验证性能优化 (Pre-Hashing):**
    - [ ] 研究并实施 Pre-Hashing 方案，显著降低大环规模下的签名/验证时间。
    - [ ] **(后续)** 增加对 Pre-Hash 计算过程正确性的验证机制。
- [ ] **算法复杂度优化:** 识别并优化代码中复杂度过高的算法（例如，随用户数指数增长的算法）。
- [ ] **存储优化:** 优化选民登记信息和投票结果的存储方式，减少冗余，提高效率。

### 安全性强化 (待办)
- [ ] **依赖库安全审计:** 对所有第三方库，特别是密码学库进行安全审查或专业审计。
- [ ] **抗 DoS 攻击:** 分析攻击面并实施流量限制、请求验证等缓解措施。

### 易用性与用户体验 (待办)
- [ ] **真正的客户端:** 为 Voter 之外的其他三方开发真正的客户端。
- [ ] **私钥泄露检测机制:** 选民无须投票即可通过查看公开记录中的 key_image 或链接签名来发现私钥被盗用。
- [ ] **客户端易用性:** 开发对普通用户更友好的桌面或手机客户端。
- [ ] **错误处理与反馈:** 改进客户端和服务器的错误处理，提供更清晰的提示。

### 测试 (待办)
- [ ] **单元测试:** 为核心模块编写全面的单元测试。
- [ ] **集成测试:** 设计并实施集成测试。
- [ ] **压力测试:** 进行压力测试以评估性能和稳定性。

## 8. 安装与使用

### 8.1 Tor 网络部署

本项目提供了一个示例 Tor 配置文件 `veri_anon_vote_server.torrc`。使用此配置运行服务器端具有以下优势：

* **无需公网 IP 或域名:** 服务器可以通过 Tor 的 Onion Service v3 地址访问，无需购买公网IP和域名。
* **增强匿名性:** 强制所有客户端（选民）通过 Tor 网络连接服务器，进一步隐藏选民的真实 IP 地址，提升匿名保护。
* **内置加密与认证:** Tor Onion Service v3 地址本身包含了服务的公钥，客户端连接时会自动验证，避免了传统 HTTPS 中可能存在的证书颁发机构 (CA) 被攻击或伪造的风险。

**配置方法:** TODO


## 9. 许可证
Apache-2.0 license


## 10. 参与与贡献

| [加入讨论组](https://matrix.to/#/#verianonvote:matrix.org) |
|----------------------------------------------------------|


## 11. 捐赠支持

如果你欣赏这个项目, 欢迎匿名捐赠, 让我敢辞掉社畜工作全职开发 (:

Paypal: https://paypal.me/RyderFreeman4Logos

monero: 4AhAFwmzX1FgZRwWokLRJ6WenbH9MWpVPMjATPg15Mvp81AUwchWfRX9XFNuQ2Loxg2V8KTogCAPTZTe6JYXA9JPMDaTWhp

